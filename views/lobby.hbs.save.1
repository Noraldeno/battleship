<div class="container">

  <div class="lobby-header row">

    <span class="col-2"> Lobby </span>
    <span class="col"></span>
    <button id="createRoomButton" class="col-2 btn btn-primary">Create Room</button>

  </div>

  <div class="row">

    <div class="col-9 room-list" id="room-list-container">
      <ul id="room-list">
        {{#each lobby as | room |}}
            <li class="room-item"> Room <span class="roomNum">{{room.id}}</span> - Player 1:<span class="player1Name"></span> {{#if room.player1}} {{room.player1}} {{else}} <button data-room-id="{{room.id}}" class="btn btn-primary player1Join">Join</button> {{/if}} ---------- 
                                    Player 2: <span class="player2Name"></span>{{#if room.player2}} {{room.player2}} {{else}} <button data-room-id="{{room.id}}" class="btn btn-primary player2Join">Join</button> {{/if}}</li>
        {{/each}}
      </ul>
    </div>

    <div id="user-list" class="col-3 user-list-container">

    </div>

  </div>

  <div class="row">
  
    <div id="chat-box" class="col chat-container">
    </div>
  
    <input class="form-control" type="text" id="message" placeholder="Enter Message"></input><button class="btn btn-primary" id="message-send">Send</button>

  </div>


</div>
<script src="js/socket.io.js"></script>
<script>

  /* LOBBY CHAT */
  let socket = io('http://138.197.217.228:3000/')
  let messageSend = document.getElementById('message-send');
  let username = '{{session.username}}';

  //Load Users onto list
  socket.emit('lobby-connect', {

    username:username,

  })

  socket.on('load-users', (data)=>{
    if(data.users){
      let userList = document.getElementById('user-list');
      userList.innerHTML = '';
      data.users.forEach((user)=>{

        let username = document.createElement('div');
        username.innerHTML = user.username;

        userList.append(username);
      })
    }
  })

  //Send message on click Send
  messageSend.addEventListener('click', (e)=>{
    e.preventDefault();

    let message = document.getElementById('message').value;

    socket.emit('message-send', {
      username: username,
      message: message,
    })

    document.getElementById('message').value = '';
  })

  //Put message on chat box
  socket.on('message-sent', (data)=>{
    let chatBox = document.getElementById('chat-box');
    let message = document.createElement('div');
    message.innerHTML = data.username + ": " + data.message;

    chatBox.appendChild(message);

    chatBox.scrollTop = chatBox.scrollHeight;
  })

  /* LOBBY CHAT END */

  /* CREATE ROOMS */
  let createRoomButton = document.getElementById('createRoomButton');

  createRoomButton.addEventListener('click', ()=>{
    fetch('lobby/createRoom', {
      method:'post',
      credentials: 'include',
    }).then( ()=>{
      socket.emit('create-room');
    })

  })

  socket.on('created-room', (room)=>{
    let roomListContainer = document.getElementById('room-list-container');
    let roomList = document.getElementById('room-list');
    let roomItem = document.createElement('li');
    roomItem.setAttribute('class', 'room-item');
    let roomId = room.id;
    roomItem.innerHTML = `Room <span class="roomNum">${roomId}</span> - Player 1:<span class="player1Name"><span>  <button data-room-id="${roomId}"class="btn btn-primary player1Join">Join</button> ---------- Player 2:<span class="player2Name"></span> <button data-room-id="${roomId}" class="btn btn-primary player2Join">Join</button>`;
    
    roomList.appendChild(roomItem);
    setJoinButtons();

    roomListContainer.scrollTop = roomListContainer.scrollHeight;
  })
  
  /* CREATE ROOMS END */

  /* JOIN ROOM */
  setJoinButtons();
 
  function setJoinButtons(){
    let player1Joins = document.getElementsByClassName('player1Join');
    let player2Joins = document.getElementsByClassName('player2Join');
 
    [].forEach.call(player1Joins, (each)=>{
      each.addEventListener('click', ()=>{
        let roomId = parseInt(each.getAttribute('data-room-id'));

        fetch('/lobby/player1Join/' + roomId, {
          method:'post',
          credentials:'include',
        }).then(()=>{
          socket.emit('player1Join', {
            roomId: roomId
          })
          window.open('/game/' + roomId);
        })

      })
    });

    [].forEach.call(player2Joins, (each)=>{
      each.addEventListener('click', ()=>{
        let roomId = parseInt(each.getAttribute('data-room-id'));

        fetch('/lobby/player2Join/' + roomId, {
          method:'post',
          credentials:'include',
        }).then(()=>{
          window.open('/game/' + roomId);
        })

      })
    });
  }

  /* JOIN ROOM END */

</script>
